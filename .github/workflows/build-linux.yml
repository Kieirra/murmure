name: build-linux
on:
    workflow_call:

jobs:
    build-linux:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: lts/*

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install Linux deps (official + extras)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libwebkit2gtk-4.1-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev \
                    patchelf \
                    libasound2-dev \
                    libxdo-dev \
                    unzip

            - name: Download & extract ONNX model (Linux)
              shell: bash
              run: |
                  set -euo pipefail
                  url="https://github.com/Kieirra/murmure-model/releases/download/1.0.0/parakeet-tdt-0.6b-v3-int8.zip"
                  tmp="/tmp/model.zip"
                  echo "Downloading $url"
                  curl -L -o "$tmp" "$url"
                  echo "Unzipping into ./resources"
                  unzip -o "$tmp" -d resources
                  ls -al resources

            - name: Restore Tauri signing key
              run: echo "${{ secrets.TAURI_PRIVATE_KEY }}" | base64 -d > tauri.key

            - name: Install frontend deps
              run: pnpm install

            - name: Build (AppImage)
              run: pnpm tauri build --bundles appimage

            - name: Sign AppImage(s) with Tauri signer
              env:
                  TAURI_PRIVATE_KEY_PATH: tauri.key
                  TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              shell: bash
              run: |
                  files=$(find src-tauri/target/release/bundle -type f -name "*.AppImage")
                  if [ -n "$files" ]; then
                    pnpm tauri signer sign $files
                  else
                    echo "No AppImage found to sign."
                  fi

            - name: Rename AppImage files to remove version and add architecture
              shell: bash
              run: |
                  find src-tauri/target/release/bundle -name "*.AppImage" -exec sh -c 'mv "$1" "$(dirname "$1")/Murmure_amd64.AppImage"' _ {} \;
                  find src-tauri/target/release/bundle -name "*.sig" -exec sh -c 'mv "$1" "$(dirname "$1")/Murmure_amd64.AppImage.sig"' _ {} \;

            - name: Upload artifact (1 day)
              uses: actions/upload-artifact@v4
              with:
                  name: murmure-linux
                  path: |
                      src-tauri/target/release/bundle/**/*.AppImage
                      src-tauri/target/release/bundle/**/*.sig
                  retention-days: 1
